<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/fullcalendar-calendar/fullcalendar-theme.html">
<link rel="import" href="../bower_components/fullcalendar-calendar/fullcalendar-calendar.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/neon-animation/animations/scale-up-animation.html">
<link rel="import" href="../bower_components/neon-animation/animations/scale-down-animation.html">
<link rel="import" href="../bower_components/iron-collapse/iron-collapse.html">

<dom-module id="time-travel-calendar">
    <template>
        <style include="iron-flex">
            :host {
                display: block;
                padding: 10px;
            }

            .card {
                box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
                padding: 16px;
                margin: 0 24px 24px 24px;
                border-radius: 5px;
                background-color: #fff;
                color: #757575;
            }

            .circle {
                display: inline-block;
                height: 64px;
                width: 64px;
                border-radius: 50%;
                background: #ddd;
                line-height: 64px;
                font-size: 30px;
                color: #555;
                text-align: center;
            }

            h1.title {
                font-size: 22px;
                font-weight: 100;
                margin: 0 0 16px 0;
                color: #212121;
            }

            paper-icon-button,
            iron-icon,
            [icon] {
              color: rgba(0, 0, 0, 0.6);
            }

            .dropdown-content iron-icon {
              padding-right: 15px;
            }

            paper-menu-button {
              padding: 0;
            }

            .actions {
              margin: 0 24px 0 11px;
            }

            --fullcalendar {

            }
        </style>

        <iron-ajax auto
                   url="pca.json"
                   method="GET"
                   handle-as="json"
                   on-response="aquirePCA"></iron-ajax>

        <iron-ajax auto
                   url="hours.json"
                   method="GET"
                   handle-as="json"
                   on-response="aquireHours"></iron-ajax>

        <div class="actions layout horizontal">
            <h1 class="title flex">
                <paper-icon-button id="previous" icon="chevron-left" on-transitionend="previous"></paper-icon-button>

                [[ title ]]

                <paper-icon-button id="next" icon="chevron-right" on-transitionend="next"></paper-icon-button>
            </h1>

            <paper-icon-button icon="search"></paper-icon-button>

            <paper-menu-button>
                <paper-icon-button icon="{{ selectedViewIcon }}" class="dropdown-trigger"></paper-icon-button>

                <paper-menu class="dropdown-content" selected="0">
                    <paper-item view="month" icon="view-module" on-tap="changeView">
                        <iron-icon icon="view-module" view="month"></iron-icon> Month
                    </paper-item>

                    <paper-item view="agendaWeek" icon="view-week" on-tap="changeView">
                        <iron-icon icon="view-week" view="agendaWeek"></iron-icon> Week
                    </paper-item>

                    <paper-item view="agendaDay" icon="view-day" on-tap="changeView">
                        <iron-icon icon="view-day" view="agendaDay"></iron-icon> Day
                    </paper-item>
                </paper-menu>
            </paper-menu-button>

            <paper-icon-button icon="today" on-tap="jumpToToday"></paper-icon-button>
        </div> <!-- end .actions -->

        <div id="calendar" class="card">
            <fullcalendar-calendar options="{{ options }}"
                                   view="{{ view }}"
                                   on-view-render="setTitle"
                                   on-day-click="addTime"
                                   on-event-click="editTime">
            </fullcalendar-calendar>
        </div> <!-- end #calendar -->

        <paper-dialog id="dialog"
                      entry-animation="scale-up-animation"
                      exit-animation="scale-down-animation">
            <h1>{{ dialogTitle }}</h1>

            <form is="iron-form"
                  id="timeForm"
                  method="POST"
                  action="">

                <paper-dropdown-menu label="Project Code (PCA)" id="pca">
                    <paper-listbox class="dropdown-content">
                        <template is="dom-repeat" items="{{ pca }}">
                            <paper-item>
                                {{ item.title }}
                            </paper-item>
                        </template>
                    </paper-listbox>
                </paper-dropdown-menu>

                <paper-dropdown-menu label="Start Time" id="startTime">
                    <paper-listbox class="dropdown-content">
                        <template is="dom-repeat" items="{{ hours }}">
                            <paper-item>{{ index }}</paper-item>
                        </template>
                    </paper-listbox>
                </paper-dropdown-menu>

                <paper-dropdown-menu label="End Time" id="endTime">
                    <paper-listbox class="dropdown-content">
                        <template is="dom-repeat" items="{{ hours }}">
                            <paper-item>{{ index }}</paper-item>
                        </template>
                    </paper-listbox>
                </paper-dropdown-menu>

                <paper-input label="Description" id="description"></paper-input>

                <paper-button raised on-click="submitTime">Save</paper-button>
            </form>
        </paper-dialog>
    </template>

    <script>
        Polymer({
            is: 'time-travel-calendar',

            properties: {
                calendar: {
                    type: Function,
                    value: function() {
                        return Polymer.dom(this.root).querySelector('fullcalendar-calendar');
                    }
                },
                dialogTitle: {
                    type: String,
                    value: null
                },
                options: {
                    type: Object,
                    value: {
                        header: false,
                        events: [
                            { title: 'General Administration', start: moment() }
                        ]
                    }
                },
                selectedViewIcon: {
                    type: String,
                    value: 'view-module'
                },
                newTime: {
                    type: Object,
                    value: {}
                },
                pca: {
                    type: Array,
                    value: null
                },
                hours: {
                    type: Array,
                    value: null
                }
            },

            changeView: function(event) {
                var selectedView     = event.target.attributes.getNamedItem('view').value,
                    selectedViewIcon = event.target.attributes.getNamedItem('icon').value;

                this.calendar.changeView(selectedView);
                this.selectedViewIcon = selectedViewIcon;
            },

            previous: function() { this.calendar.previous(); },

            next: function() { this.calendar.next(); },

            jumpToToday: function(event) { console.log(event); },

            setTitle: function(event) {
                this.title = event.detail.view.title;
            },

            aquirePCA: function(pca) {
                this.pca = pca.detail.response;
            },

            aquireHours: function(hours) {
                this.hours = hours.detail.response;
            },

            addTime: function(event) {
                var date = moment(event.detail.date).format('MMM DD, YYYY');

                Polymer.dom(this.root).querySelector('#dialog').open();
                this.dialogTitle = 'Add New Time on ' + date;
                this.newTime.date = event.detail.date;
            },

            editTime: function(event) {
                var date = moment(event.detail.date).format('MMM DD, YYYY');

                Polymer.dom(this.root).querySelector('#dialog').open();
                this.dialogTitle = 'Edit ' + event.detail.event.title + ' Time on ' + date;
            },

            submitTime: function(event) {
                this.newTime.title       = this.$.pca.value;
                this.newTime.start       = moment(this.newTime.date).hour(this.$.startTime.value);
                this.newTime.end         = moment(this.newTime.date).hour(this.$.endTime.value);
                this.newTime.description = this.$.description.value;

                this.options.events.push(this.newTime);
                console.log(this.options.events);

                // Polymer.dom(event).localTarget.parentElement.submit();
            }
        });
    </script>
</dom-module>
